# Current Architecture Documentation (2025)

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

Statuslineã¯**2ã¤ã®ç‹¬ç«‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ **ã‚’æä¾›ã—ã¾ã™ï¼š

### ğŸ—œï¸ ã‚·ã‚¹ãƒ†ãƒ 1: ä¼šè©±åœ§ç¸®ç›£è¦– (Compact Line)
- **è¡¨ç¤º**: Line 2 - `ğŸª™  Compact: 140.5K/160.0K`
- **ç›®çš„**: ç¾åœ¨ã®ä¼šè©±ãŒ160Kåœ§ç¸®é–¾å€¤ã«åˆ°é”ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç›£è¦–
- **ãƒ‡ãƒ¼ã‚¿æº**: ç¾åœ¨ã®ä¼šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¼ã‚¯ãƒ³
- **ãƒªã‚»ãƒƒãƒˆ**: ä¼šè©±ãŒåœ§ç¸®ã•ã‚Œã‚‹æ™‚

### ğŸ• ã‚·ã‚¹ãƒ†ãƒ 2: 5æ™‚é–“èª²é‡‘ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ (Session/Burn Lines)
- **è¡¨ç¤º**: Line 3-4 - `â±ï¸ Session` + `ğŸ”¥ Burn`
- **ç›®çš„**: Claude Codeå…¬å¼ã®5æ™‚é–“èª²é‡‘æœŸé–“ã‚’è¿½è·¡
- **ãƒ‡ãƒ¼ã‚¿æº**: 5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å†…ã®å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³
- **ãƒªã‚»ãƒƒãƒˆ**: 5æ™‚é–“æ¯ (Claude Codeå…¬å¼ä»•æ§˜)

## è©³ç´°å®Ÿè£…

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### Compact Line (Line 2) å‡¦ç†
```python
# ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼
main() 
  â†’ detect_five_hour_blocks()      # 5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ¤œå‡º
  â†’ calculate_block_statistics()   # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦çµ±è¨ˆè¨ˆç®—
  â†’ total_tokens = block_stats['total_tokens']  # ç¾åœ¨ã®å®Ÿè£…
  â†’ percentage = (total_tokens / COMPACTION_THRESHOLD) * 100
  â†’ ğŸª™ Compactè¡¨ç¤º
```

**æ³¨æ„**: ç¾åœ¨ã®å®Ÿè£…ã§ã¯5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€æœ¬æ¥ã¯ç¾åœ¨ã®ä¼šè©±ã®ã¿ã‚’è¿½è·¡ã™ã¹ãã§ã™ã€‚

#### Session/Burn Lines (Lines 3-4) å‡¦ç†  
```python
# Session Line (Line 3) - ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ä»˜ã
block_stats['duration_seconds'] â†’ session_duration
block_stats['start_time'] â†’ session_start_time
block_progress = (hours_elapsed % 5) / 5 * 100
session_bar = get_progress_bar(block_progress, show_current_segment=True)
â±ï¸ Sessionè¡¨ç¤º (ç¾åœ¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç™½ãå¼·èª¿)

# Burn Line (Line 4) - 5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦çµ±åˆ  
generate_real_burn_timeline(block_stats, current_block) â†’ burn_timeline
create_sparkline(burn_timeline) â†’ ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³
ğŸ”¥ Burnè¡¨ç¤º + 5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å…¨ä½“ã®ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³
```

### å‹•çš„ä½ç½®æƒãˆã‚·ã‚¹ãƒ†ãƒ 

#### calculate_dynamic_padding()
```python
def calculate_dynamic_padding(compact_text, session_text):
    # ANSIè‰²ã‚³ãƒ¼ãƒ‰é™¤å»
    clean_compact = re.sub(r'\x1b\[[0-9;]*m', '', compact_text)
    clean_session = re.sub(r'\x1b\[[0-9;]*m', '', session_text)
    
    # é•·ã•å·®åˆ†è¨ˆç®— + è¦–è¦šèª¿æ•´
    if session_len < compact_len:
        return ' ' * (compact_len - session_len + 1)  # +1 for visual adjustment
```

#### é©ç”¨ç®‡æ‰€
- Line 2/3ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ä½ç½®æƒãˆ
- å¯å¤‰é•·ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œ (`1m` â†’ `23h59m`)
- Line 4ã®æ•°å€¤ä½ç½®èª¿æ•´ (`ğŸ”¥ Burn:    numbers`)

### Claude Code JSONLçµ±åˆ

#### ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç†è§£
```python
# å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®usage = ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚ç‚¹ã§ã®ç´¯ç©å€¤
message_usage = {
    "input_tokens": 5,              # æ–°è¦å…¥åŠ›
    "output_tokens": 267,           # æ–°è¦å‡ºåŠ›  
    "cache_creation_input_tokens": 748,    # æ–°è¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½œæˆ
    "cache_read_input_tokens": 80473       # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†åˆ©ç”¨
}
# åˆè¨ˆ: 81,493ãƒˆãƒ¼ã‚¯ãƒ³ (98%ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥å†åˆ©ç”¨)
```

#### ã‚³ã‚¹ãƒˆè¨ˆç®—ã®ç¾å®Ÿ
```python
# å…¸å‹çš„ãªã‚³ã‚¹ãƒˆå†…è¨³ (Claude Sonnet 4)
input_cost = (5 * $3.00) / 1M = $0.000015
output_cost = (267 * $15.00) / 1M = $0.004005
cache_creation = (748 * $3.75) / 1M = $0.002805
cache_read = (80473 * $0.30) / 1M = $0.024142
# åˆè¨ˆ: $0.031 (98%ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿å–ã‚Šã®ãŸã‚å®‰ä¾¡)
```

### é‡è¦ãªé–¢æ•°ãƒãƒƒãƒ—

#### 5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–¢é€£
```python
detect_five_hour_blocks()
â”œâ”€â”€ Purpose: Claude Code 5æ™‚é–“èª²é‡‘ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ¤œå‡º
â”œâ”€â”€ Input: all_messages (å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)
â”œâ”€â”€ Output: 5æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ
â””â”€â”€ Used by: Session/Burn lines

calculate_block_statistics()
â”œâ”€â”€ Purpose: 5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çµ±è¨ˆè¨ˆç®—
â”œâ”€â”€ Input: 5æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯
â”œâ”€â”€ Output: ç´¯ç©ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
â””â”€â”€ Used by: Both systems (è¦æ”¹å–„)
```

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£
```python
calculate_tokens_since_time()
â”œâ”€â”€ Purpose: æŒ‡å®šæ™‚åˆ»ã‹ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³è¨ˆç®—
â”œâ”€â”€ Input: session_id, start_time
â”œâ”€â”€ Output: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç´¯ç©ãƒˆãƒ¼ã‚¯ãƒ³
â””â”€â”€ Used by: Burn line

get_burn_line()
â”œâ”€â”€ Purpose: ğŸ”¥ Burn lineç”Ÿæˆ
â”œâ”€â”€ Input: session_data, session_id
â”œâ”€â”€ Output: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿è¡¨ç¤º
â””â”€â”€ Features: sparkline, burn rate
```

#### UIé–¢é€£
```python
get_progress_bar()
â”œâ”€â”€ Purpose: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç”Ÿæˆï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ä»˜ãï¼‰
â”œâ”€â”€ Input: percentage, width, show_current_segment
â”œâ”€â”€ Output: Unicode progress bar (ç¾åœ¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¼·èª¿å¯èƒ½)
â””â”€â”€ Used by: Lines 2, 3 (Line 3ã§ã¯ç¾åœ¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¼·èª¿)

create_sparkline()
â”œâ”€â”€ Purpose: Unicode sparklineç”Ÿæˆ
â”œâ”€â”€ Input: values, width
â”œâ”€â”€ Output: â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆ visualization
â””â”€â”€ Used by: Burn line
```

## è¨­å®šã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
cd statusline
python3 install.py
```

### æ‰‹å‹•è¨­å®š
```json
# ~/.claude/settings.json
{
  "statusLine": {
    "type": "command",
    "command": "~/.claude/statusline.py",
    "padding": 0
  }
}
```

### ç’°å¢ƒå¤‰æ•° (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
```bash
export CLAUDE_PROJECTS_DIR="/custom/path/to/projects"
export CLAUDE_CACHE_DIR="/custom/path/to/cache"
export STATUSLINE_MODE="multi"  # single|multi
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ä¸€èˆ¬çš„ãªå•é¡Œ

#### 1. ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œãªã„
- Claude Codeã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œä¸­ã‹ç¢ºèª
- `~/.claude/projects/*/session-id.jsonl` ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
- Python 3.7+ ã®ç¢ºèª

#### 2. æ™‚é–“ãŒæ­£ã—ããªã„
- ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«å¤‰æ›æ¸ˆã¿
- 5æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯ã¯æ¨™æº–åŒ–ã•ã‚ŒãŸèª²é‡‘åˆ†æç”¨

#### 3. ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ãšã‚Œ
- å‹•çš„ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒè‡ªå‹•èª¿æ•´
- æ¥µç«¯ã«é•·ã„æ–‡å­—åˆ—ã®å ´åˆã¯å¾®èª¿æ•´ãŒå¿…è¦

#### 4. ã‚³ã‚¹ãƒˆãŒå®‰ã™ãã‚‹
- æ­£å¸¸: 98-99%ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥å†åˆ©ç”¨
- æ–°è¦å‡¦ç†ã¯æ•°ç™¾ãƒˆãƒ¼ã‚¯ãƒ³ãƒ¬ãƒ™ãƒ«
- $0.03-0.05ã¯å…¸å‹çš„

### ãƒ­ã‚°ç¢ºèª
```bash
tail -f ~/.claude/statusline-error.log
```

## é–‹ç™ºè€…å‘ã‘æ³¨æ„äº‹é …

### çµ¶å¯¾ã«å®ˆã‚‹ã¹ãåŸå‰‡
1. **æ¦‚å¿µåˆ†é›¢**: Compact â‰  Session/Burn
2. **å‹•çš„å¯¾å¿œ**: å›ºå®šã‚¹ãƒšãƒ¼ã‚¹ã®ä½¿ç”¨ç¦æ­¢
3. **ãƒ†ã‚¹ãƒˆå¾Œå ±å‘Š**: æ¨æ¸¬ã§ã®æˆåŠŸå ±å‘Šç¦æ­¢
4. **æ—¢å­˜æ©Ÿèƒ½ä¿è­·**: å‹•ä½œã™ã‚‹æ©Ÿèƒ½ã®å‰Šé™¤ç¦æ­¢

### æ”¹å–„ãŒå¿…è¦ãªç®‡æ‰€
1. **Compact Line**: 5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±
3. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: ã‚ˆã‚ŠæŸ”è»Ÿãªè¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
4. **ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ**: è‡ªå‹•ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

### æœ€æ–°ã®æ”¹å–„å®Œäº†äº‹é … (2025-08-19)
1. âœ… **Burn Lineçµ±åˆ**: Session lineã¨åŒã˜5æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
2. âœ… **ç¾åœ¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¼·èª¿**: Session lineã§é€²è¡Œä¸­ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç™½ããƒã‚¤ãƒ©ã‚¤ãƒˆ
3. âœ… **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹çµ±ä¸€**: current_block['messages']ã§å®Œå…¨çµ±åˆ
4. âœ… **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**: Session/Burn lineã®å®Œå…¨æ™‚é–“è»¸ä¸€è‡´

### æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ
1. **æ–°ã—ã„è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰**: 1è¡Œç‰ˆã€ç°¡æ˜“ç‰ˆ
2. **ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½**: é–¾å€¤åˆ°é”æ™‚ã®é€šçŸ¥
3. **ãƒ­ã‚°åˆ†æ**: è©³ç´°ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
4. **GUIç‰ˆ**: Webãƒ™ãƒ¼ã‚¹ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰